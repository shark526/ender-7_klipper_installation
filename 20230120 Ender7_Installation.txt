Install/reference Klipper on Creality Ender 7

Install/reference Notes:
  -Inbuilt screen will no longer work, incompatable with klipper (creality wont release sorce code)
  -Require Raspberry Pi(or pc) for host
  -with klipper installed no safety anymore printer can crash/break if incorrect config (do so at your own risk)
  -Throughly test printer


#1 Install Mainsail_OS
Raspberry Pi Imager
  Choose OS > Other specific-purpose OS > 3D printing > Mainsail OS
    -hostname: mainsail
    -enable ssh
    -user: pi -pwd:
    -configure wireless network

On Mainsail_OS First Boot
  -wait for file system to expand
  -log in to web interface
     update components from web interface
     > settings > machine > Update Manager

Download Ender 7 Klipper Pack (Klipper printer.cfg)(Ender 7 Board Pins)
  https://github.com/johnson-thomas/Creality-Ender7-Klipper-Starter-Pack
  -Good start for getting Klipper working with Ender 7
  -Will need tuning to suit specific printer
  -Does not include details for use with probe(BLTouch)


#Ender 7 Machine Info (prior to Klipper install)
Board: Creality CR-FDM-v2.4.S1_v101
  Power input: 24v
  Processor: ARM® Cortex®-M3 STM32F1 Microcontroller IC 32-Bit Single-Core 72MHz 512KB (512K x 8) FLASH
    -STM32F103RET6
    -32bit
  Pinout (hardware names) [! preceding name to indicate reverse polarity] [^ preceding hardware pull-up resistor] [~ preceding hardware pull-down resistor]
    [stepper_x]
    step_pin: PC2
    dir_pin: PB9
    enable_pin: !PC3
    endstop_pin: ^PA5

    [stepper_y]
    step_pin: PB8
    dir_pin: !PB7
    enable_pin: !PC3
    endstop_pin: ^PA6

    [stepper_z]
    step_pin: PB6
    dir_pin: PB5
    enable_pin: !PC3
    endstop_pin: ^PA7

    [extruder]
    step_pin: PB4
    dir_pin: !PB3
    enable_pin: !PC3
    heater_pin: PA1
    sensor_pin: PC5

    [heater_bed]
    heater_pin: PA15
    sensor_pin: PC4

    [fan]
    pin: PA0

    [filament_switch_sensor filament_sensor]
    switch_pin: !PA4

    [bltouch]
    sensor_pin: ^PB1
    control_pin: PB0

M503                                                             # Report Settings
  Recv:   G21    ; Units in mm (mm)
  Recv: 
  Recv:   M200 S0 D1.75                                          #M200 - Set Filament Diameter
  Recv:   M92 X200.00 Y200.00 Z400.00 E140.00                    #M92 - Set Axis Steps-per-unit
  Recv:   M203 X500.00 Y500.00 Z10.00 E60.00                     #M203 - Set Max Feedrate
  Recv:   M201 X500.00 Y500.00 Z100.00 E5000.00                  #M201 - Print Move Limits
  Recv:   M204 P500.00 R1000.00 T500.00                          #M204 - Set Starting Acceleration
  Recv:   M205 B20000.00 S0.00 T0.00 X8.00 Y8.00 Z0.40 E5.00     #M205 - Set Advanced Settings [B -Minimum segment time (µs)][S -Minimum feedrate for print moves (units/s)][T -Minimum feedrate for travel moves (units/s)][X -X max jerk (units/s)][Y -Y max jerk (units/s)][Z -Z max jerk (units/s)][E -E max jerk (units/s)]
  Recv:   M206 X0.00 Y0.00 Z0.00                                 #M206 - Set Home Offsets
  Recv:   M420 S1 Z10.00                                         #M420 - Bed Leveling State [S -Set enabled or disabled][Z -Set Z fade height (Requires ENABLE_LEVELING_FADE_HEIGHT)]
  Recv:   M301 P12.50 I0.70 D60.00                               #M301 - Set Hotend PID [P -Proportional value][I -Integral value][D -Derivative value]
  Recv:   M304 P327.11 I19.20 D1393.45                           #M304 - Set Bed PID
  Recv:   M413 S0                                                #M413 - Power-loss Recovery
  Recv:   M851 X30.00 Y27.00 Z-2.60                              #M851 - XYZ Probe Offset

#Build printer.cfg for Klipper to work
//**
[include mainsail.cfg]
#[include macros.cfg]

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: corexy
max_velocity: 500                                              # max feedrate (E7:500)(Other:300)
max_accel: 3000
max_z_velocity: 10
max_z_accel: 100

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
rotation_distance: 32
microsteps: 32
endstop_pin: ^PA5
position_endstop: 0
position_max: 250
homing_speed: 50

[stepper_y]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PC3
rotation_distance: 32
microsteps: 32
endstop_pin: ^PA6
position_endstop: 250
position_max: 250
homing_speed: 50

[stepper_z]
step_pin: PB6
dir_pin: PB5
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
#endstop_pin: ^PA7                                             # disable to use BLTouch
#position_endstop: 3.0                                         # disable to use BLTouch
endstop_pin: probe:z_virtual_endstop                           # enable to use BLTouch
position_min: -3.5                                             # enable to use BLTouch
position_max: 300

[extruder]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PC3
microsteps: 16
rotation_distance: 23.564                                      # (original:22.84)
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 200.0
pressure_advance = 0                                           # 0 to disable (original:0.520) requires calibration
#HOT END VARIABLES
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
control: pid                                                   # tuned for stock hardware with 50 degree Celsius target(automatically commented out after first calibration)
pid_Kp: 19.122                                                 PID_CALIBRATE HEATER=extruder TARGET=200
pid_Ki: 0.898
pid_Kd: 101.825
min_temp: 0
max_temp: 230

[heater_bed]
heater_pin: PA15
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid                                                   # tuned for stock hardware with 50 degree Celsius target(automatically commented out after first calibration)
pid_Kp: 70.499                                                 # updated with PID_CALIBRATE HEATER=heater_bed TARGET=60
pid_Ki: 1.546
pid_Kd: 803.686
min_temp: 0
max_temp: 75

[fan]
pin: PA0

[filament_switch_sensor filament_sensor]
pause_on_runout: true
switch_pin: !PA4

[bltouch]                                                      # enable for BLTouch (requires self_test after each firmware restart)(BLTOUCH_DEBUG COMMAND=self_test)(different config depending BLTouch version)
sensor_pin: ^PB1
control_pin: PB0
z_offset: 2.542                                                # initial safe value, get correct value by PROBE_CALIBRATE
x_offset: -28.28
y_offset: -28.28

[safe_z_home]                                                  # BLTouch home x,y axis then move to centre and home z
home_xy_position: 125, 125                                     # Change coordinates to the center of your print bed
speed: 50
z_hop: 10                                                      # Move up 10mm
z_hop_speed: 5

[bed_mesh]
speed: 120
horizontal_move_z: 10                                          #lift z between movements
mesh_min: -25, -25                                             # x, y (x: 0-28.28=-28.28, -28.28+250= 221.72)
mesh_max: 190, 190
probe_count: 4
//**

#Upload printer.cfg to Klipper
Mainsail_os > settings > machine > config files > upload file > printer.cfg
  save and restart


#2 Building klipper.bin and flashing micro-controller

ssh to raspberry pi
  confirm printer serial communication port
    ls /dev/serial/by-id/*
      /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

  navigate to dir
    cd ~/klipper/

  run klipper firmware configuration
    make menuconfig
    //**
    [*] Enable extra low-level configuration options
        Micro-controller Architecture (STMicroelectronics STM32) --->
        Processor model (STM32F103) --->
    [ ] Disable SWD at startup (for GigaDevice stm32f103 clones)
        Bootloader offset (28Kib bootloader) --->
        Clock Reference (8 MHz crystal) --->
        Communication interface (Serial (on USART1 PA10/PA9)) --->
    (250000) Baud rate for serial port
    (!PA15) GPIO pins to set at micro-controller startup
    //**

    !PA15 required to prevent bed heater turning on automatically at printer start

  run klipper compile firmware.bin
    make
  
  navigate to klipper.bin
    cd ~/klipper/out/klipper.bin

  flash micro-controller (ender 7 board)
    copy klipper.bin to micro sd card
    rename klipper.bin to unique filename (must not match any previous filename)(add date)
      klipper.bin > klipper20230121.bin
    ensure nothing else is connected to printer during flashing of micro-controller(board)
    insert sd card into printer and wait for firmware to flash
      screen will not indicate anything just wait a few minutes before connecting klipper(raspberry pi) and confirm flashing is completed


#3 Thoroughly test printer (warning can crash printer, be ready to turn of power if somthing goes wrong)
  Checklist
    -individually check heated bed and hotend temps (set small values and check if temp readings are as expected)
    -check functionality of all endstops
    -check homing
    -check extruder operation(direction)
    -perform PID tuning for heated bed and hotend
    -check your extruder is able to extrude the instructed amount of filament 
       calibrate e-steps
       calibrate flow rate


  Check heated_bed and hotend
    -Set heater_bed temp check heat then turn off and check for cool down (safe operation)
       SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=30
       SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    -Set heater_bed temp check heat then turn off and check for cool down (safe operation)
       SET_HEATER_TEMPERATURE HEATER=extruder TARGET=50
       SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    -TURN_OFF_HEATERS

  Check endstops (with BLTouch)
    M83    #disable motors
      -manually move print head away from end stops to center
      -manually lower print bed out of way

    With nothing touching the enstops
    QUERY_ENDSTOPS
      x:open y:open z:open

    Manually press each endstop(x,y) switch and check operation
    QUERY_ENDSTOPS
      x:triggered y:triggered z:open

    Test BLTouch operation
      bltouch_debug command=pin_down      #pin goes down, light goes off
      bltouch_debug command=pin_up        #pin goes up, red light goes on

      bltouch_debug command=pin_down
      bltouch_debug command=touch_mode
        query_probe
          probe: open
        slightly press bltouch probe so it lights up but doest retract all the way
        query_probe
          probe: triggered
        QUERY_ENDSTOPS
          x:open y:open z:triggered

      bltouch_debug command=self_test    #pin goes down and up repeatedly, red light stays on
      bltouch_debug command=reset        #reset probe if fault(blinking)

  Check Homing 
    Verify stepper motor operation (Move axis 1mm back and forth 10 times)
      STEPPER_BUZZ STEPPER=stepper_x
      STEPPER_BUZZ STEPPER=stepper_y
      STEPPER_BUZZ STEPPER=stepper_z

    Verify direction and homeing(endstop) per axis
    X-axis
      G28 x
    Y-axis
      G28 y
    Z-axis (probe should drop first then bed will start moving)
      G28 z

  Calibrate z-offset
    probe_calibrate

    adjust z-offset (peice of paper just dragging between nozzle and bed)
      testz=-.1
      testz=+.1

    when happy with adjustment enter accept command in console
      accept

  Verify accuracy of z-offset
    probe_accuracy
       0.0125 or better, 0.025 no worse
       (example returned standard deviation of 0.002077)

  Check extruder operation(direction)(no filament)
    M83             #Set E-Relative
    G1 E100 F100    #Extrude
    G1 E-100 F100   #Retract

  Perform PID tuning for heated bed and hotend (feed in filament so hotend is not empty for test)
    PID_CALIBRATE HEATER=<config_name> TARGET=<temperature>

    PID_CALIBRATE HEATER=extruder TARGET=200
      returned:
        PID parameters: pid_Kp=21.862 pid_Ki=1.139 pid_Kd=104.939
    PID_CALIBRATE HEATER=heater_bed TARGET=60
      returned:
        PID parameters: pid_Kp=74.515 pid_Ki=1.153 pid_Kd=1204.353

    When PID tuning completed
      save_config

  Check your extruder is able to extrude the instructed amount of filament
    Calibrate e-steps (klipper: rotation_distance)
      -Obtaining rotation_distance from steps_per_mm (approximation)
         M503                                        #Retrieve printer firmware settings
         M92 X200.00 Y200.00 Z400.00 E140.00         #M92 - Set Axis Steps-per-unit

         1.8 degree motor (full rotation = 200 steps (360/1.8=200))
         16 microsteps
         140 e-steps
         rotation_distance = <full_steps_per_rotation> * <microsteps> / <steps_per_mm>
           200 * 16 / 140 = 22.857

      -Obtaining rotation_distance from measure and trim
         Heat extruder to 210C with filament

         Mark Filament at 100mm from intake to extruder
         Mark Filament at 120mm from intake to extruder

         Extrude 100mm filament (low speed minimul pressure in extruder)
           G91           #extruder relative
           G1 E100 F100  #extrude 100mm

         Measure remaining distance to mark (120mm mark to beginning of extruder)
           0.4 @210 100mm
           remaining = 23mm
           actual_extrude_distance = <initial_mark_distance> - <subsequent_mark_distance>
           120 - 23 = 97mm

         Previous e-steps
           140/100= 1.4 step per mm

         Current e-steps
           120-23= 97                  #Actual length extruded = 120mm – (Length from the extruder to mark after extruding)
           1.4*97= 135.8               #Accurate steps/mm = (Old steps/mm × Actual length extruded)
  
         New rotation_distance for klipper
           200*(16/135.8)= 23.564      #rotation_distance (Klipper)


    Calibrate flow rate (specific to each filament)
      PrusaSlicer (extrusion multiplier)
        PrusaSlicer Generic PLA
          Nozzle, First Layer:210C, Other Layers:205C
          Bed,    First Layer:60C,  Other Layers:60C

      Create/download a flow rate calibration model (50mm solid cube) and slice
        Slicer settings:
          -Layer Height: 0.2mm (or set to your normal printer layer height)
             PrusaSlicer > print settings > layers and perimeters > Layer height
          -Line Width: 0.4 (wall thickness)
             PrusaSlicer > print settings > advanced > default extrusion width
          -Wall Count(Perimeters): 1
             PrusaSlicer > print settings > layers and perimeters > Perimeters
          -Infill Density: Set to 0%
          -Top layers: set to 0 to make cube hollow
             PrusaSlicer > print settings > layers and perimeters > Solid layers > Top
          -Print Speed: Set to your normal wall printing speed
             PrusaSlicer > print settings > layers and perimeters > Perimeters (default 40mm/s)

      Print Model with settings above
        Klipper flow_rate_calibration Print Stats, Perimeter:(Speed: 15mm/s)(Flow: 1.1mm^3/s)

      Measure each wall thickness at center on print with calipers
        0.36, 0.4, 0.39, 0.35       #Wall Count= 1
        0.36+ 0.4+ 0.39+ 0.35= 1.5
        1.5/4= 0.375 average wall(mm)

      New flow rate (%) = (0.4 ÷ average wall width) × 100
        (0.4/0.375)*100= 106.667%
        Extrusion Multiplier: 106.667% = 1.07

      PrusaSlicer Extrusion Multiplier (Between 0.9-1.1)
        Filament Settings > Filament > Extrusion multiplier = 1.07


#4 Advanced features
  -Klipper macros
  -Determine extruder maximum flow rate(mm^3/s)(maximum printing speed)
  -Calibrate pressure advance
  -Calibrate resonance compensation (requires ADXL345)


  Klipper Macros (PrusaSlicer)
    Create Macros.cfg
      //**
      [gcode_macro PRINT_START]
      gcode:
        {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
        {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(220)|float %}
        G90                           #Use absolute coordinates
        SET_GCODE_OFFSET Z=0.0        #Reset the g-code z offset
        M83                           #Extruder relative mode
        M107                          #Set fan off
        G28                           #Home printer axis
        M104 S150                     #preheat extruder, minimise oozing
        M190 S{BED_TEMP}              #Set and wait for bed heating
        BED_MESH_CALIBRATE            #Automatic bed leveling
        G1 Z50 F240                   #Move z_axis down to 50mm
        M109 S{EXTRUDER_TEMP}         #Set and wait for hotend heating
        #Prime Nozzle (Left)
        G1 X2 Y10 F3000               #Move x,y axis
        G1 Z0.28 F240                 #Move z axis
        G92 E0                        #reset extruder distance to 0
        G1 X2.0 Y140 E10 F1500        #first pass prime
        G1 X2.3 Y140 F5000            #offset
        G92 E0                        #reset extruder distance to 0
        G1 X2.3 Y10 E10 F1200         #second pass prime
        G92 E0                        #reset extruder distance to 0

      [gcode_macro PRINT_STOP]
      gcode:
        G91                           #Use relative coordinates
        G1 Z10                        #Lower z axis by 10mm
        G28 X Y                       #Move gantry out of way to home
        M140 S0                       #turn off heatbed
        M104 S0                       #turn off temperature
        M107                          #turn off fan
        #M84 X Y E                     #disable motors
        M84                           #disable all motors

      [gcode_macro CANCEL_PRINT]
      description: Cancel running print
      rename_existing: CANCEL_PRINT_BASE
      gcode:
        TURN_OFF_HEATERS
        CANCEL_PRINT_BASE
        G91                           #Use relative coordinates
        G1 Z10                        #Lower z axis by 10mm
        G90                           #Use absolute coordinates
        G28 X Y                       #Move gantry out of way to home
        M84                           #disable all motors
      //**

    Upload macros.cfg to Klipper
      Mainsail_os > settings > machine > config files > upload file > macros.cfg
    save and restart

    PrusaSlicer Start g-code
      ;E7 Klipper start macro
      M104 S0
      M140 S0
      PRINT_START EXTRUDER_TEMP={first_layer_temperature[0]} BED_TEMP={first_layer_bed_temperature[0]}

    PrusaSlicer End g-code
      ;E7 Klipper stop macro
      PRINT_STOP


  Determine extruder maximum flow rate(mm^3/s)(maximum printing speed)
    Melting rate (hotend PID tuning)
    Maximum feed rate (extruder)
      M83                #Set e to relative
      M109 S210          #Set and wait for nozzle temp [210C]
      Increase the extrusion speed until the extruder starts to lose steps then take last value
      F60 = 60mm/min = 1mm/s
      G1 E50 F60         #Start at 1mm/s extrude 50mm
      G1 E50 F120        #2mm/s
      G1 E50 F180        #3mm/s
      G1 E50 F240        #4mm/s
      G1 E50 F300        #5mm/s
      G1 E50 F360        #6mm/s
      G1 E50 F420        #7mm/s
      G1 E50 F480        #8mm/s
      G1 E50 F540        #9mm/s
      G1 E50 F600        #10mm/s losing steps

      540mm/min / 60sec = 9mm/s
      Max feed rate = 9mm/s

    Determine filament cross section
      diameter: 1.75mm
      radius: 1.75/2= 0.875mm
      cross section: pi*0.875^2= 2.405mm^2

    Determine maximum flow rate
      maximum_flow_rate(mm^3/s) = <max_extrusion_speed> * <filament_cross_section>
        9mm/s * 2.405mm^2 = 21.645mm^3/s

    PrusaSlicer, max volumetric speed(experimental feature [limit all extrusion movements to not exceed max volumetric speed])
      Filament Settings > Advanced > Print speed override > Max volumetric speed = 7.215 (default:15mm^3/s)
      Print Settings > Speed > Auto Speed(advanced) > Max volumetric speed = 7.215

    Speed = <volumetric flow> / <layer height> / <line width>
      21.645 / 0.2 / 0.4 = 270.56mm/s

    Volumetric flow = <speed> * <layer height> * <line width>
      270 * 0.2 * 0.4 = 21.6mm^3/s


  Pressure Advance (advanced extrusion calibration)(requires e-steps/flow-rate calibration first)(specific to each filament)
    Download Klipper pressure advance square tower
      https://www.klipper3d.org/prints/square_tower.stl

    Slicer settings 
      Zero infill
      Coarse layer height (75% of nozzle diameter)(0.4 nozzle = 0.3 layer height)
      Any kind of slicer dynamic acceleration is disabled
      Use a high speed (eg,100mm/s) (prusaslicer default:40mm/s)(extruder max flow rate may need to measured first)
        
    Prepare for test (klipper commands before starting print)
      SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
      -direct drive extruder
         TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.005
      -long bowden extruders
         TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.020

      Print square_tower.stl
        -if corners are no longer printing well print can be cancelled

      Measure with calipers from bottom of print to where corners look best
        eg, height= 30mm

      Calculate pressure advance (bowden)
        pressure_advance = <start> + <measured_height> * <factor>
        0 + (30 * 0.02) = 0.6
        <calculated_value> = 0.6

        Typical pressure advance values are between 0.050 and 1.000
      
      Update printer.cfg (pressure_advance = <calculated_value>)
        [extruder]
        pressure_advance = 0.6


  Resonance compensation (requires ADXL345)

